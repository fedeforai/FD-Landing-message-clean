<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FrostDesk Booking</title>

  <!-- Supabase client (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0e0f12;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #e5e7eb;
    }

    .container {
      max-width: 560px;
      margin: 0 auto;
      padding: 32px;
      background: #1a1d22;
      margin-top: 48px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      text-align: center;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #ffffff;
      letter-spacing: -0.5px;
    }

    p.subtitle {
      text-align: center;
      color: #9ca3af;
      margin-bottom: 32px;
      font-size: 15px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      color: #c7c7c7;
    }

    select, input, textarea {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background: #24272e;
      border: 1px solid #3d414a;
      border-radius: 12px;
      color: white;
      transition: 0.2s ease;
      box-sizing: border-box;
    }

    select:focus, input:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      outline: none;
    }

    textarea { height: 120px; }

    .button {
      width: 100%;
      padding: 16px;
      margin-top: 20px;
      background-color: #3b82f6;
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.25s ease;
    }

    .button:hover {
      background-color: #2563eb;
      transform: translateY(-1px);
    }

    .button.secondary {
      background-color: #111318;
      border: 1px solid #3d414a;
      font-size: 16px;
      margin-top: 10px;
    }

    .button.secondary:hover {
      background-color: #171a22;
      transform: translateY(-1px);
    }

    .card {
      margin-top: 24px;
      padding: 20px;
      background: #24272e;
      border-radius: 16px;
      border: 1px solid #2f333a;
      animation: fadeIn 0.4s ease;
    }

    .card img {
      width: 140px;
      height: 140px;
      border-radius: 16px;
      object-fit: cover;
      margin-bottom: 14px;
    }

    #success {
      text-align: center;
      color: #22c55e;
      font-weight: bold;
      margin-top: 20px;
      display: none;
    }

    #errorMsg {
      text-align: center;
      color: #f97373;
      font-weight: 500;
      margin-top: 12px;
      display: none;
      font-size: 14px;
    }

    #altBox { display: none; }
    #altList {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .smallMuted {
      color: #9ca3af;
      font-size: 13px;
      margin-top: 10px;
    }

    /* MINI CHAT (MODAL) */
    #chatOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 18px;
      box-sizing: border-box;
    }

    #chatModal {
      width: 100%;
      max-width: 560px;
      background: #111318;
      border: 1px solid #2f333a;
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.55);
      overflow: hidden;
    }

    #chatHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid #2f333a;
      background: #0e0f12;
    }

    #chatHeaderTitle {
      font-weight: 700;
      font-size: 14px;
      color: #e5e7eb;
    }

    #chatClose {
      background: transparent;
      border: 1px solid #2f333a;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    #chatClose:hover {
      background: #171a22;
    }

    #chatBody {
      padding: 14px 16px;
      height: 320px;
      overflow-y: auto;
      background: #111318;
    }

    .chatMsg {
      padding: 10px 12px;
      border-radius: 14px;
      margin-bottom: 10px;
      line-height: 1.35;
      font-size: 14px;
      border: 1px solid #2f333a;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .chatMsg.ai {
      background: #0e0f12;
      color: #e5e7eb;
    }

    .chatMsg.user {
      background: #1a1d22;
      color: #ffffff;
      border-color: #3d414a;
    }

    #chatFooter {
      display: flex;
      gap: 10px;
      padding: 12px 12px;
      border-top: 1px solid #2f333a;
      background: #0e0f12;
      box-sizing: border-box;
    }

    #chatInput {
      flex: 1;
      height: 46px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #3d414a;
      background: #24272e;
      color: #ffffff;
      font-size: 14px;
      box-sizing: border-box;
    }

    #chatSend {
      width: 120px;
      height: 46px;
      border-radius: 12px;
      border: none;
      background: #3b82f6;
      color: #ffffff;
      font-weight: 700;
      cursor: pointer;
    }

    #chatSend:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    #chatMeta {
      padding: 0 16px 14px 16px;
      color: #9ca3af;
      font-size: 12px;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>FrostDesk</h1>
  <p class="subtitle">Scrivi direttamente al tuo maestro e controlla la sua agenda</p>

  <label>Seleziona il maestro</label>
  <select id="instructorSelect">
    <option value="">Scegli un maestro</option>
  </select>

  <div id="instructorCard" class="card" style="display:none;">
    <img id="photo" alt="Foto maestro">
    <h2 id="name"></h2>
    <p id="bio"></p>
  </div>

  <form id="bookingForm">
    <label>Nome</label>
    <input id="customerName" placeholder="Il tuo nome">

    <label>Telefono</label>
    <input id="phone" placeholder="+39...">

    <label>Messaggio</label>
    <textarea id="message" placeholder="Scrivi qui la tua richiesta"></textarea>

    <button class="button" id="sendBtn" type="submit">Invia richiesta</button>
  </form>

  <p id="success">Messaggio inviato con successo.</p>
  <p id="errorMsg">Errore nell'invio, controlla la console.</p>

  <div id="altBox" class="card">
    <h3 style="margin:0 0 10px 0;">Risposta</h3>
    <p id="altMsg" style="color:#e5e7eb; font-size:14px; margin:0;"></p>
    <div id="altList" style="margin-top:12px;"></div>
    <div id="altMeta" class="smallMuted"></div>
  </div>
</div>

<!-- MINI CHAT MODAL -->
<div id="chatOverlay">
  <div id="chatModal">
    <div id="chatHeader">
      <div id="chatHeaderTitle">Completiamo la richiesta</div>
      <button id="chatClose" type="button">Chiudi</button>
    </div>

    <div id="chatBody"></div>
    <div id="chatMeta"></div>

    <div id="chatFooter">
      <input id="chatInput" placeholder="Scrivi qui..." autocomplete="off" />
      <button id="chatSend" type="button">Invia</button>
    </div>
  </div>
</div>

<script>
  /* =========================
     CONFIG
     ========================= */
  const SUPABASE_URL = "https://ncvkipizapkhawnaqssm.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jdmtpcGl6YXBraGF3bmFxc3NtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjY3ODcsImV4cCI6MjA4MDQ0Mjc4N30.sx3o0u4Me8zc-tDt_abt3Q8PMORfgFu7xSzFUZjlBEM";

  // Endpoint principale Make (A0→A5, B/C/D/E)
  const MAKE_WEBHOOK_URL = "https://hook.eu1.make.com/8eo529jglgiqrehsdm0k8rtul68jsmox";
  // Endpoint conferma booking (alternative)
  const MAKE_CONFIRM_WEBHOOK_URL = "PASTE_CONFIRM_WEBHOOK";
  // Endpoint mini chat (raccolta campi mancanti)
  const MAKE_CHAT_WEBHOOK_URL = "PASTE_CHAT_WEBHOOK";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* =========================
     CONVERSATION ID (persistente)
     ========================= */
  const CONVERSATION_KEY = "fd_conversation_id";

  function getConversationId() {
    return localStorage.getItem(CONVERSATION_KEY);
  }

  function setConversationId(id) {
    if (id) localStorage.setItem(CONVERSATION_KEY, id);
  }

  /* =========================
     STATE
     ========================= */
  let selectedInstructor = null;
  let lastBasePayload = null;

  // Stato mini chat
  const CHAT_STORAGE_KEY = "fd_chat_session_id";
  let chatSessionId = null;
  let chatMissingFields = [];
  let chatDraftFields = {};

  /* =========================
     DOM REFS
     ========================= */
  let successEl, errorEl, altBox, altMsg, altList, altMeta, sendBtn, instructorSelect, bookingForm;
  let chatOverlay, chatClose, chatBody, chatInput, chatSend, chatMeta;

  /* =========================
     DOMContentLoaded
     ========================= */
  window.addEventListener("DOMContentLoaded", () => {
    // Main UI
    successEl = document.getElementById("success");
    errorEl = document.getElementById("errorMsg");
    altBox = document.getElementById("altBox");
    altMsg = document.getElementById("altMsg");
    altList = document.getElementById("altList");
    altMeta = document.getElementById("altMeta");
    sendBtn = document.getElementById("sendBtn");
    instructorSelect = document.getElementById("instructorSelect");
    bookingForm = document.getElementById("bookingForm");

    instructorSelect.addEventListener("change", loadInstructor);
    bookingForm.addEventListener("submit", sendMessage);

    // Chat UI
    chatOverlay = document.getElementById("chatOverlay");
    chatClose = document.getElementById("chatClose");
    chatBody = document.getElementById("chatBody");
    chatInput = document.getElementById("chatInput");
    chatSend = document.getElementById("chatSend");
    chatMeta = document.getElementById("chatMeta");

    chatClose.addEventListener("click", () => closeChat());
    chatSend.addEventListener("click", () => onChatSend());
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        onChatSend();
      }
    });

    chatSessionId = getOrCreateChatSessionId();

    loadInstructors();
  });

  /* =========================
     HELPERS UI
     ========================= */
  function resetFeedback() {
    successEl.style.display = "none";
    errorEl.style.display = "none";
    altBox.style.display = "none";
    altList.innerHTML = "";
    altMsg.textContent = "";
    altMeta.textContent = "";
  }

  function setSending(isSending) {
    sendBtn.disabled = !!isSending;
    sendBtn.textContent = isSending ? "Invio in corso..." : "Invia richiesta";
    sendBtn.style.opacity = isSending ? "0.85" : "1";
    sendBtn.style.cursor = isSending ? "not-allowed" : "pointer";
  }

  function setChatSending(isSending) {
    chatSend.disabled = !!isSending;
    chatSend.textContent = isSending ? "..." : "Invia";
  }

  function safeText(v) {
    return (v ?? "").toString();
  }

  function isSchemaString(v) {
    if (!v) return false;
    const s = v.toString().trim();
    return s === '{"type":"string"}' || s.includes('"type":"string"');
  }

  function normalizeMessage(rawMsg) {
    const s = safeText(rawMsg);
    if (!s) return "Richiesta ricevuta.";
    if (isSchemaString(s)) return "Ok. Per procedere mi servono alcune info.";
    return s;
  }

  function showMessageOnly(message) {
    altBox.style.display = "block";
    altMsg.textContent = message;
    altList.innerHTML = "";
    altMeta.textContent = "";
  }

  function showError(message) {
    errorEl.textContent = message || "Errore";
    errorEl.style.display = "block";
  }

  function formatSlot(startISO, endISO) {
    try {
      const start = new Date(startISO);
      const end = new Date(endISO);

      const date = start.toLocaleDateString("it-IT", { day: "2-digit", month: "long" });
      const startTime = start.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
      const endTime = end.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });

      return `${date} · ${startTime} - ${endTime}`;
    } catch {
      return "Alternativa disponibile";
    }
  }

  /* =========================
     MINI CHAT HELPERS
     ========================= */
  function getOrCreateChatSessionId() {
    const existing = localStorage.getItem(CHAT_STORAGE_KEY);
    if (existing) return existing;
    const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("chat_" + Date.now());
    localStorage.setItem(CHAT_STORAGE_KEY, id);
    return id;
  }

  function openChat(initialAiMessage, missingFields) {
    chatMissingFields = Array.isArray(missingFields) ? missingFields : [];

    chatOverlay.style.display = "flex";
    chatBody.innerHTML = "";

    addChatMsg("ai", initialAiMessage || "Dimmi pure i dettagli mancanti.");

    if (chatMissingFields.length > 0) {
      chatMeta.textContent = "Mi servono: " + chatMissingFields.join(", ");
    } else {
      chatMeta.textContent = "Rispondi qui con i dettagli.";
    }

    setTimeout(() => chatInput.focus(), 150);
    scrollChatToBottom();
  }

  function closeChat() {
    chatOverlay.style.display = "none";
  }

  function addChatMsg(role, text) {
    const div = document.createElement("div");
    div.className = "chatMsg " + (role === "user" ? "user" : "ai");
    div.textContent = text;
    chatBody.appendChild(div);
    scrollChatToBottom();
  }

  function scrollChatToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  async function onChatSend() {
    const userText = safeText(chatInput.value).trim();
    if (!userText) return;

    if (!MAKE_CHAT_WEBHOOK_URL) {
      addChatMsg("ai", "Manca MAKE_CHAT_WEBHOOK_URL. Incolla l'URL del webhook mini chat.");
      return;
    }

    addChatMsg("user", userText);
    chatInput.value = "";
    setChatSending(true);

    try {
      const payload = {
        session_id: chatSessionId,
        conversation_id: getConversationId() || null,
        instructor_id: lastBasePayload?.instructor_id || null,
        instructor_name: lastBasePayload?.instructor_name || null,
        calendar_id: lastBasePayload?.calendar_id || null,
        customer_name: lastBasePayload?.name || null,
        customer_phone: lastBasePayload?.phone || null,
        original_message: lastBasePayload?.message || null,
        missing_fields: chatMissingFields,
        user_message: userText,
        client_tz: lastBasePayload?.client_tz || Intl.DateTimeFormat().resolvedOptions().timeZone,
        source: "landing_chat"
      };

      const res = await fetch(MAKE_CHAT_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const contentType = res.headers.get("content-type") || "";
      let data;
      if (contentType.includes("application/json")) data = await res.json();
      else data = { ok: res.ok, message: await res.text() };

      if (!res.ok) {
        addChatMsg("ai", normalizeMessage(data?.message) || "Errore nella chat.");
        setChatSending(false);
        return;
      }

      addChatMsg("ai", normalizeMessage(data?.message));

      if (Array.isArray(data?.missing_fields)) {
        chatMissingFields = data.missing_fields;
        if (chatMissingFields.length > 0) chatMeta.textContent = "Mi servono: " + chatMissingFields.join(", ");
        else chatMeta.textContent = "Ok. Ultimo dettaglio e poi procediamo.";
      }

      if (data?.is_complete === true) {
        const uf = (data?.updated_fields && typeof data.updated_fields === "object") ? data.updated_fields : {};
        chatDraftFields = { ...chatDraftFields, ...uf };

        setTimeout(async () => {
          closeChat();

          const merged = {
            ...lastBasePayload,
            ...chatDraftFields,
            message: lastBasePayload?.message || ""
          };

          await callMakeEndpoint(merged);
        }, 300);
      }

      setChatSending(false);
    } catch (err) {
      console.error("Errore mini chat:", err);
      addChatMsg("ai", "Errore rete. Riprova tra pochi secondi.");
      setChatSending(false);
    }
  }

  /* =========================
     SUPABASE: INSTRUCTORS
     ========================= */
  async function loadInstructors() {
    try {
      const { data, error } = await supabase
        .from("instructors")
        .select("*")
        .order("name", { ascending: true });

      if (error) {
        console.error("Errore Supabase instructors:", error);
        return;
      }

      data.forEach(inst => {
        const opt = document.createElement("option");
        opt.value = inst.id;
        opt.textContent = inst.name;
        instructorSelect.appendChild(opt);
      });
    } catch (err) {
      console.error("Errore in loadInstructors:", err);
    }
  }

  async function loadInstructor() {
    resetFeedback();

    const id = instructorSelect.value;
    if (!id) return;

    try {
      const { data, error } = await supabase
        .from("instructors")
        .select("*")
        .eq("id", id)
        .single();

      if (error) {
        console.error("Errore Supabase loadInstructor:", error);
        return;
      }

      selectedInstructor = data;

      const card = document.getElementById("instructorCard");
      card.style.display = "block";
      document.getElementById("photo").src = data.photo_url || "";
      document.getElementById("name").textContent = data.name || "";
      document.getElementById("bio").textContent = data.bio || "";
    } catch (err) {
      console.error("Errore in loadInstructor:", err);
    }
  }

  /* =========================
     SUBMIT: SEND MESSAGE
     ========================= */
  async function sendMessage(event) {
    event.preventDefault();
    resetFeedback();

    if (!selectedInstructor) {
      alert("Seleziona prima un maestro");
      return;
    }

    const payload = {
      conversation_id: getConversationId() || null,
      instructor_id: selectedInstructor.id,
      calendar_id: selectedInstructor.calendar_id,
      instructor_name: selectedInstructor.name || null,
      name: safeText(document.getElementById("customerName").value),
      phone: safeText(document.getElementById("phone").value),
      message: safeText(document.getElementById("message").value),
      client_tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
      source: "landing"
    };

    lastBasePayload = payload;
    chatMissingFields = [];
    chatDraftFields = {};

    await callMakeEndpoint(payload);
  }

  /* =========================
     MAIN ENDPOINT (Make)
     ========================= */
  async function callMakeEndpoint(payload) {
    setSending(true);

    try {
      const res = await fetch(MAKE_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const contentType = res.headers.get("content-type") || "";
      let data;

      if (contentType.includes("application/json")) data = await res.json();
      else data = { ok: res.ok, message: await res.text() };

      if (data.conversation_id) {
        setConversationId(data.conversation_id);
      }

      if (!res.ok) {
        showError(normalizeMessage(data?.message) || "Errore nell'invio.");
        setSending(false);
        return;
      }

      const normalizedMsg = normalizeMessage(data?.message);

      // status "ask_info" → solo risposta informativa
      if (data?.status === "ask_info") {
        showMessageOnly(normalizedMsg);
        setSending(false);
        return;
      }

      // status "need_more_info" → apri mini chat
      if (data?.status === "need_more_info") {
        const mf = Array.isArray(data?.missing_fields) ? data.missing_fields : [];
        openChat(normalizedMsg, mf);
        setSending(false);
        return;
      }

      // status "slot_busy" → alternative
      if (data?.status === "slot_busy") {
        const alts = Array.isArray(data?.alternatives) ? data.alternatives : [];
        renderAlternatives(normalizedMsg, alts);
        setSending(false);
        return;
      }

      // status "ready_to_check" o "confirmed" → ok
      if (data?.ok === true) {
        successEl.textContent = normalizedMsg || "Richiesta inviata con successo.";
        successEl.style.display = "block";
        setSending(false);
        return;
      }

      // fallback
      showMessageOnly(normalizedMsg);
      setSending(false);

    } catch (err) {
      console.error("Errore fetch verso Make:", err);
      showError("Errore rete.");
      setSending(false);
    }
  }

  /* =========================
     SLOT BUSY: ALTERNATIVES
     ========================= */


  function renderAlternatives(message, alternatives) {
    altBox.style.display = "block";
    altMsg.textContent = message || "Quello slot è già occupato. Ti propongo alcune alternative:";
    altList.innerHTML = "";
    altMeta.textContent = "";

    const firstTwo = alternatives.slice(0, 2);

    firstTwo.forEach((a) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "button secondary";
      btn.textContent = formatSlot(a.start_time, a.end_time); // ← usa start_time / end_time

      btn.onclick = async () => {
        resetFeedback();
        altBox.style.display = "block";
        altMsg.textContent = "Perfetto, sto confermando questa alternativa...";
        altList.innerHTML = "";
        altMeta.textContent = "";

        await confirmBooking({
          ...lastBasePayload,
          chosen_start_time: a?.start_time || null,
          chosen_end_time: a?.end_time || null
        });
      };

      altList.appendChild(btn);
    });

    if (firstTwo.length === 0) {
      showMessageOnly("Mi dispiace, ma non ho alternative immediate. Puoi indicarmi un altro orario?");
    }
  }


  /* =========================
     CONFIRM BOOKING
     ========================= */
  async function confirmBooking(payload) {
    if (!MAKE_CONFIRM_WEBHOOK_URL) {
      showError("Manca MAKE_CONFIRM_WEBHOOK_URL. Incolla l'URL del webhook di conferma.");
      return;
    }

    try {
      const res = await fetch(MAKE_CONFIRM_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const contentType = res.headers.get("content-type") || "";
      let data;

      if (contentType.includes("application/json")) data = await res.json();
      else data = { ok: res.ok, message: await res.text() };

      if (!res.ok) {
        showError(normalizeMessage(data?.message) || "Errore nella conferma.");
        return;
      }

      const msg = normalizeMessage(data?.message) || "Booking confermato.";
      showMessageOnly(msg);

      const ref = safeText(data?.booking_ref || data?.reference || "");
      const st = safeText(data?.start_time || payload?.chosen_start_time || "");
      const en = safeText(data?.end_time || payload?.chosen_end_time || "");
      const inst = safeText(data?.instructor_name || payload?.instructor_name || "");

      const lines = [];
      if (inst) lines.push(`Maestro: ${inst}`);
      if (st && en) lines.push(`Orario: ${formatSlot(st, en)}`);
      if (ref) lines.push(`Riferimento: ${ref}`);

      altMeta.textContent = lines.join(" | ");
      altBox.style.display = "block";

    } catch (err) {
      console.error("Errore confirmBooking:", err);
      showError("Errore rete nella conferma.");
    }
  }
</script>
</body>
</html>
