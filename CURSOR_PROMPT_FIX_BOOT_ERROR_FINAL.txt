REPO: Orchestrator (Supabase Edge Functions)
FILE: supabase/functions/ingest-inbound/index.ts

üö® PROBLEMA CRITICO:
L'Edge Function `ingest-inbound` fallisce con BOOT_ERROR. La funzione non si avvia.

‚úÖ SOLUZIONE IMMEDIATA - FIX IN 3 STEP:

STEP 1: VERIFICA MODULI _SHARED (CAUSA PI√ô PROBABILE)
Il codice importa moduli che potrebbero non esistere:
- `../_shared/logger.ts`
- `../_shared/security.ts`
- `../_shared/ragSearch.ts`

AZIONE: Controlla se esistono. Se mancano, creali con questo codice minimo:

üìÅ supabase/functions/_shared/logger.ts:
```typescript
export function createLogger(traceId: string) {
  return {
    traceId,
    setTraceId: (id: string) => { this.traceId = id; },
    info: (event: string, data?: Record<string, unknown>) => {
      console.log(`[INFO] ${event}`, JSON.stringify(data || {}));
    },
    warn: (event: string, data?: Record<string, unknown>) => {
      console.warn(`[WARN] ${event}`, JSON.stringify(data || {}));
    },
    error: (event: string, data?: Record<string, unknown>) => {
      console.error(`[ERROR] ${event}`, JSON.stringify(data || {}));
    },
  };
}
```

üìÅ supabase/functions/_shared/security.ts:
```typescript
export function constantTimeCompare(a: string | null, b: string | null): boolean {
  if (!a || !b) return false;
  if (a.length !== b.length) return false;
  let result = 0;
  for (let i = 0; i < a.length; i++) {
    result |= a.charCodeAt(i) ^ b.charCodeAt(i);
  }
  return result === 0;
}
```

üìÅ supabase/functions/_shared/ragSearch.ts:
```typescript
export async function searchPolicyChunks(
  supabase: any,
  instructorId: string,
  queryEmbedding: number[],
  topK: number
): Promise<{ chunks: Array<{chunk_text: string; doc_title: string; similarity: number}>; error?: string }> {
  // Implementazione minima - restituisce array vuoto per ora
  return { chunks: [] };
}

export async function generateEmbedding(
  text: string,
  apiKey: string
): Promise<number[]> {
  // Implementazione minima - chiama OpenAI se necessario
  try {
    const response = await fetch("https://api.openai.com/v1/embeddings", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "text-embedding-3-small",
        input: text,
      }),
    });
    const data = await response.json();
    return data.data[0]?.embedding || [];
  } catch (error) {
    console.error("Embedding generation failed:", error);
    return [];
  }
}

export function buildRAGPrompt(
  userMessage: string,
  instructorData: { id: string; name?: string; email?: string; metadata?: Record<string, unknown> },
  chunks: Array<{chunk_text: string; doc_title: string; similarity: number}>
): string {
  let prompt = `You are a helpful AI assistant for a ski instructor.\n\n`;
  if (instructorData.name) {
    prompt += `Instructor: ${instructorData.name}\n`;
  }
  if (chunks.length > 0) {
    prompt += `\nRelevant Information:\n${chunks.map(c => c.chunk_text).join("\n\n")}\n\n`;
  }
  prompt += `User Question: ${userMessage}\n\nAnswer concisely and helpfully.`;
  return prompt;
}
```

STEP 2: VERIFICA VARIABILI D'AMBIENTE
Vai su Supabase Dashboard ‚Üí Project Settings ‚Üí Edge Functions ‚Üí Secrets

Verifica che siano presenti (OBBLIGATORIE):
‚úÖ SUPABASE_URL (pu√≤ essere derivato automaticamente)
‚úÖ SUPABASE_SERVICE_ROLE_KEY (OBBLIGATORIO)
‚úÖ FD_INGEST_KEY (OBBLIGATORIO - deve corrispondere a quello su Vercel)
‚úÖ OPENAI_API_KEY (OBBLIGATORIO per AI replies)

Opzionali:
- SUPABASE_ANON_KEY (solo se usi JWT authentication)

STEP 3: AGGIUNGI LOGGING DIAGNOSTICO
Aggiungi all'inizio di `Deno.serve` per diagnosticare:

```typescript
Deno.serve(async (req) => {
  // Log diagnostico all'avvio
  console.log("[ingest-inbound] Function started");
  console.log("[ingest-inbound] Environment check:", {
    has_supabase_url: !!Deno.env.get("SUPABASE_URL"),
    has_service_role_key: !!Deno.env.get("SUPABASE_SERVICE_ROLE_KEY"),
    has_fd_ingest_key: !!Deno.env.get("FD_INGEST_KEY"),
    has_openai_key: !!Deno.env.get("OPENAI_API_KEY"),
  });

  // ... resto del codice esistente
});
```

üß™ TEST RAPIDO:
Dopo il fix, testa con questa richiesta dalla Landing:
1. Invia un messaggio
2. Verifica che la risposta includa `replyText`
3. Controlla i log di Supabase per errori

üìã CHECKLIST POST-FIX:
- [ ] Moduli `_shared` creati e deployati
- [ ] Variabili d'ambiente configurate su Supabase
- [ ] `FD_INGEST_KEY` corrisponde tra Vercel e Supabase
- [ ] Funzione si avvia senza BOOT_ERROR
- [ ] Log mostrano "Function started"
- [ ] Richiesta dalla Landing riceve `replyText`

üéØ PRIORIT√Ä:
1. CRITICO: Crea moduli `_shared` se mancano
2. CRITICO: Verifica variabili d'ambiente
3. IMPORTANTE: Aggiungi logging diagnostico
4. TEST: Verifica che `replyText` sia restituito

‚ö†Ô∏è NOTA: Se dopo questi fix la funzione ancora non si avvia, controlla i log di Supabase per errori specifici di sintassi o import.
